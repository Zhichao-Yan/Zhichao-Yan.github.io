---
layout: post
title: Linux启动过程
date: 2025-05-18 19:16 +0800
media_subpath: "/../assets/img/pic1"
image: "../head/green.jpg"
description: Linux启动详解
categories: [操作系统,Linux]
toc: true
comments: false
math: true
mermaid: true
hidden: false
pin: true
---
### 主板阶段
1. 启动电源：计算机的电源单元（PSU）开始向主板和其他硬件组件供电
2. 启动BIOS/UEFI：在硬件加电后，CPU会从一个固定的内存地址（通常是0xFFFF0）开始执行指令
这个地址通常指向主板上的BIOS或UEFI固件


### UEFI/BIOS阶段
1. 执行硬件自检(POST)：BIOS或UEFI会执行硬件自检
    * CPU：检查CPU是否正常工作。
    * 内存：检测内存是否正常，通常会进行内存测试。
    * 存储设备：检查硬盘、SSD或其他存储设备是否可以被识别。
    * 其他硬件：检测显卡、网卡、键盘、鼠标等硬件设备
2. 显示自检结果
    * 检测到问题：发出蜂鸣声或显示错误信息
    * 检测正常：显示BIOS/UEFI版本和硬件信息
3. 确定启动顺序
BIOS或UEFI会根据用户在BIOS/UEFI设置中配置的启动顺序，按顺序依次启动，如果第一个加载失败，则加载第二个。
常见的启动设备包括硬盘、USB闪存盘、光驱或网络启动，可以在UEFI/BIOS中修改启动顺序
![boot](boot1.png){: w="600" h="400" }
_默认的启动顺序_
![boot](boot2.png){: w="600" h="400" }
_更改默认的启动顺序_


4. 选择启动设备，加载引导程序。BIOS或UEFI会从选定的启动设备中加载引导程序（Bootloader）
    1. 对于BIOS，引导程序通常位于硬盘的MBR（Master Boot Record）
    2. 对于UEFI，引导程序通常位于EFI系统分区（ESP）


### 引导程序阶段
1. 系统的ESP分区通常位于`/boot/efi`
EFI系统分区（ESP，EFI System Partition）用于存放与启动相关的文件

2. 先读取并执行ESP分区的`\EFI\ubuntu\shimaa64.efi`文件,验证`GRUB`程序
> Shim主要作用是验证后续加载的引导加载程序（GRUB）的签名，确保系统启动过程的安全性
`shimaa64.efi`是Shim的64位版本，Shim是一个开源的引导加载程序，是安全启动（Secure Boot）机制的一部分。安全启动要求启动过程中的软件组件都经过数字签名认证，防止恶意软件在启动阶段加载。

```bash
yan@ubuntu:/boot/efi/EFI/ubuntu$ ls
BOOTAA64.CSV  grubaa64.efi  grub.cfg  mmaa64.efi  shimaa64.efi
```
3. 在ubuntu中，Shim验证完成后默认会尝试加载同目录下的`grubx64.efi`, 引导程序`GRUB`被加载到内存
4. `GRUB`加载自身配置，读取`/boot/grub/grub.cfg`, `grub.cfg`是由模版`/etc/grub.d`和设置`/etc/default/grub`产生
![boot](grub0.png){: w="600" h="400" }

### GRUB菜单阶段

#### 如何显示GRUB菜单
* 不进行配置文件的修改，手动进入：在开机时按住`ESC`键
* 修改配置文件，自动进入：修改`/etc/default/grub`文件中的`GRUB_TIMEOUT`，然后运行`sudo update-grub`命令

#### GRUB菜单的内容
1. 显示`GRUB`启动菜单：列出可用的操作系统和内核选项
![boot](grub.png){: w="600" h="400" }
_GRUB启动菜单_
![boot](grub3.png){: w="600" h="400" }
_GRUB菜单详细的指令_

2. 按`e`键，编辑对应选项的执行命令
![boot](grub1.png){: w="600" h="400" }

3. 菜单选项`ubuntu`的详细内容，此配置来自`/boot/grub/grub.cfg`文件


```bash
# 设置菜单选项ubuntu的命令
setparams 'Ubuntu'
# 记录启动失败的状态。如果系统未能成功启动，这个命令会确保下次启动时GRUB菜单会被显示出来，以便用户可以进行干预和修复。
recordfail
# 加载视频模块，以支持图形模式下的文本输出
load_video
# 设置图形模式。这里使用了变量 $linux_gfx_mode 来指定图形模式，该变量通常在GRUB配置文件中定义，表示启动时使用的分辨率等信息。
gfxmode $linux_gfx_mode
# 插入模块mod：这里是gzio模块，这个模块允许GRUB读取gzip压缩的数据
insmod gzio
# 检查当前的GRUB平台是否是Xen虚拟化环境。如果是，则加载xzio和lzopio模块，这些模块分别用于处理XZ和LZO压缩格式。
if [ x$grub_platform = xxen ]; then insmod xzio; insmod lzopio; fi
# 加载part_gpt模块，这个模块允许GRUB识别GPT（GUID分区表）类型的磁盘分区
insmod part_gpt
# 加载ext2模块，这个模块允许GRUB读取ext2/ext3/ext4文件系统
insmod ext2
# 查找特定文件系统UUID并设置为根分区的
search --no-floppy --fs-uuid --set=root e965ef35-5256-4b1a-a417-888d3cfaae91
# 加载Linux内核并传递启动参数
linux /vmlinuz-6.8.0-60-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro
initrd /initrd.img-6.8.0-60-generic
```

#### 常见GRUB命令
------------------
insmod：加载模块。e.g. `insmod gzio`
* 模块通常以`.mod`结尾
* 可能会存放在类似这样的路径下`/boot/grub/<arch>-<platform>/`,其中`<arch>`代表架构（例如`x86_64`），而`<platform>`可能表示引导平台。 例如`/boot/grub/arm64-efi`
![boot](grub2.png){: w="600" h="400" }

---------------------

linux：加载Linux内核并传递启动参数。e.g. `linux /vmlinuz-6.8.0-60-generic root=/dev/mapper/ubuntu--vg-ubuntu--lv ro quiet`  
格式: `linux <路径到内核映像> <内核参数>`
* `/vmlinuz-6.8.0-60-generic` 指定内核映像的路径
* `root=/dev/mapper/ubuntu--vg-ubuntu--lv`指定哪个设备包含了系统的根文件系统（即 / 分区）
> 一旦内核被加载到内存中并且开始运行，它会根据root参数指向的设备来查找并挂载根文件系统。这是启动过程中的一个关键步骤，因为这使得内核可以访问存储在根文件系统上的所有必要的程序、库和其他资源，包括用来完成启动过程的init系统或systemd。
* `ro`以只读模式挂载根文件系统
> 尽管根文件系统最初是以只读方式挂载的，但这并不意味着整个运行期间它都保持这种状态。
实际上，大多数系统会在适当的时机重新以读写（rw）方式挂载根文件系统。这通常通过`init`进程或`systemd`来完成，这样系统就可以在启动后进行必要的文件系统操作，如写入日志、安装软件包等。
* `quiet` 减少了启动时输出的信息量，让启动屏幕更简洁

---------------------
search：搜索设备的一个命令，它允许你根据不同的条件来查找设备
e.g. `search --no-floppy --fs-uuid --set=root e965ef35-5256-4b1a-a417-888d3cfaae91`
* `--no-floppy`：此选项告诉 search 命令在搜索过程中忽略软盘驱动器。由于现代计算机几乎不再使用软盘，这一步主要是为了确保不会浪费时间在不存在或不相关的设备上进行搜索
* `--fs-uuid`：此选项表示你希望基于文件系统的 UUID 来搜索设备。UUID 是一个全球唯一的标识符，分配给每个文件系统，使得它们即使在设备顺序改变的情况下也能被唯一识别。
* `--set=root`：一旦找到匹配的设备，指定搜索到的设备作为GRUB的根设备，即$root变量
    * 其在GRUB处理阶段起作用，帮助GRUB定位和加载必要的启动文件，让GRUB找到正确的设备来加载内核和initrd文件
    * 此处的UUID一般是挂载路径为`/boot`分区的UUID，因为后续的内核和initrd文件都是存放在`/boot`目录下

----------------------
initrd：在GRUB引导加载程序中用于指定初始内存盘（initial RAM disk）的路径
e.g. `initrd /initrd.img-6.8.0-60-generic`
初始内存盘是一个临时的根文件系统，它被加载到内存中并在系统启动的早期阶段使用，直到实际的根文件系统可以被挂载

-----------------------

